<html>

<head>
  <meta charset="UTF-8" />
  <title>BlockChain Challenge Box</title>
  <style>
    #box {
      width: fit-content;
      height: fit-content;
    }

    .dash {
      border: none;
      border-top: 1px dashed #ccc;
    }
  </style>
</head>

<body>
  <div id="box">
    <h1>BlockChain Challenge Box</h1>
    <hr>
    <h2>Challenge Description</h2>
    <hr>
    <div id="description"></div>
    <h2>RPC provider</h2>
    <hr>
    <div>
      The BlockChain RPC provider is: <b id="rpc"></b>
    </div>
    <h2>Contract information</h2>
    <hr>
    <div id="contract"></div>
    <h2>Faucet</h2>
    <hr>
    Your Account Address<b>(with 0x)</b>: <input id="address"></input> <button id="fund">Fund</button>
    <div id="fundResult"></div>
    <h2>Flag</h2>
    <hr>
    <button id="flag">Get Flag</button>
    <div id="flagResult"></div>
  </div>

  <script>
    let rpc = document.getElementById("rpc");
    let description = document.getElementById("description");
    let contract = document.getElementById("contract");
    let fundBtn = document.getElementById("fund");
    let fundResult = document.getElementById("fundResult");
    let addr = document.getElementById("address");
    let flagBtn = document.getElementById("flag");
    let flagResult = document.getElementById("flagResult");

    rpc.innerText = `${window.location.href}rpc`

    fetchBoxInformation();

    fundBtn.onclick = (e) => {
      fundBtn.disabled = true;
      fundResult.innerText = "Funding...";
      let address = addr.value;
      if (!/^0x[0-9a-fA-F]{40}$/.test(address)) {
        fundResult.innerText = "Invalid address";
        fundBtn.disabled = false;
        return;
      }
      fetch("/faucet", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          address: address,
        }),
      })
        .then((response) => response.json())
        .then((response) => {
          if (response.status === 'ok') {
            fundResult.innerText = "Funded successfully";
          } else {
            fundResult.innerText = "Failed to fund";
          }
        })
        .catch((e) => {
          console.log(e);
        });
      fundBtn.disabled = false;
    }

    flagBtn.onclick = (e) => {
      flagBtn.disabled = true;
      flagResult.innerText = "Getting flag...";
      fetch("/flag", {
        method: "GET",
      })
        .then((response) => response.text())
        .then((response) => {
          flagResult.innerText = response;
        })
        .catch((e) => {
          console.log(e);
        });
      flagBtn.disabled = false;
    }

    function fetchBoxInformation() {
      fetch("/box", {
        method: "GET",
      })
        .then((response) => response.json())
        .then((response) => {
          if (!response.description) {
            response.description = "None";
          } else {
            description.innerText = response.description;
          }

          let contractInfos = []
          response.contracts.forEach((c) => {
            contractInfos.push(`
                <div>Contract: ${c.name}</div>
                <div>Filenames: ${c.filename}</div>
                <div>Address: ${c.address}</div>
                `)
            contract.innerHTML = contractInfos.join("<hr class='dash'>");
          });
        })
        .catch((e) => {
          console.log(e);
        });
    }

  </script>
</body>

</html>